- name: Create/Start the api-gateway container
  hosts: all
  gather_facts: false
  collections:
    - containers.podman
  tasks:
   - name: Run api-gateway container with podman
     containers.podman.podman_container:
      name: api-gateway
      image: docker.io/springcommunity/spring-petclinic-api-gateway:latest
      state: started
      replace: true
      detach: true
      network: petclinic-net
      ports:
        - "8180:8080"
        - "9016:9016"
      env:
        SPRING_PROFILES_ACTIVE: docker
        SPRING_JMX_ENABLED: "true"
        MANAGEMENT_METRICS_EXPORT_JMX_ENABLED: "true"
        MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
        JAVA_TOOL_OPTIONS: >-
          -Dcom.sun.management.jmxremote
          -Dcom.sun.management.jmxremote.port=9016
          -Dcom.sun.management.jmxremote.rmi.port=9016
          -Dcom.sun.management.jmxremote.authenticate=false
          -Dcom.sun.management.jmxremote.ssl=false
          -Djava.rmi.server.hostname=127.0.0.1
     when: >
        api_gateway_info.containers is not defined
        or api_gateway_info.containers | length == 0
        or api_gateway_info.containers[0].State.Status != 'running'
     become: true

  - name: update the episode
    debug:
      msg: "{{ ansible_eda.event.event_id }}"
